{% extends 'pdfeditor/base.html' %}

{% block title %}More Tools{% endblock %}

{% block content %}
<!-- Confetti Canvas -->
<canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;"></canvas>

<!-- Surprise Reveal Overlay -->
<div id="surprise-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9998; display: flex; align-items: center; justify-content: center; opacity: 1; transition: opacity 1s;">
    <div style="text-align: center; color: white; animation: fadeInScale 0.8s ease-out;">
        <div style="font-size: 5rem; margin-bottom: 1rem;">üöÄ</div>
        <h1 style="font-size: 3rem; font-weight: 800; margin: 0; text-shadow: 0 4px 8px rgba(0,0,0,0.2);">PDF Editor 2.0</h1>
        <p style="font-size: 1.5rem; margin-top: 0.5rem; opacity: 0.9;">The Future of PDF Editing</p>
        <div class="loading-dots" style="margin-top: 2rem;">
            <span style="display: inline-block; width: 12px; height: 12px; background: white; border-radius: 50%; margin: 0 4px; animation: bounce 1s infinite;"></span>
            <span style="display: inline-block; width: 12px; height: 12px; background: white; border-radius: 50%; margin: 0 4px; animation: bounce 1s infinite 0.2s;"></span>
            <span style="display: inline-block; width: 12px; height: 12px; background: white; border-radius: 50%; margin: 0 4px; animation: bounce 1s infinite 0.4s;"></span>
        </div>
    </div>
</div>

<div id="more-tools-modal" style="display: block; opacity: 0; transition: opacity 0.5s;">
    <!-- PDF List View -->
    <div id="pdf-list-view" style="max-width: 1200px; margin: 3rem auto; padding: 0 1rem;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2.5rem; border-radius: 1rem; box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.2); margin-bottom: 2rem; text-align: center; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.875rem; font-weight: 600; color: white; backdrop-filter: blur(10px);">
                ‚ú® PDF Editor 2.0
            </div>
            <div style="font-size: 4rem; margin-bottom: 1rem;">üõ†Ô∏è</div>
            <h2 style="color: white; margin: 0; font-size: 2.5rem; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">Advanced PDF Command Center</h2>
            <p style="color: rgba(255,255,255,0.9); margin-top: 1rem; font-size: 1.1rem;">All your PDF tools in one powerful interface</p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
            {% for pdf in uploaded_pdfs %}
            <div class="pdf-card" data-pdf-id="{{ pdf.id }}" data-pdf-name="{{ pdf.name }}" data-pdf-path="uploads/{{ pdf.name }}" style="background: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" onmouseover="this.style.borderColor='#6366f1'; this.style.transform='translateY(-4px)'" onmouseout="this.style.borderColor='transparent'; this.style.transform='translateY(0)'">
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="font-size: 2.5rem;">üìÑ</div>
                    <div style="flex: 1; min-width: 0;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #1f2937; font-size: 1.1rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ pdf.name }}">
                            {{ pdf.name }}
                        </h4>
                        <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">
                            {{ pdf.size|filesizeformat }}
                        </p>
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="select-pdf-btn btn btn-primary" style="width: 100%;">
                        Select & Preview ‚Üí
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- PDF Preview & Tools View (hidden initially) -->
    <div id="pdf-tools-view" style="display: none; max-width: 1400px; margin: 0 auto; padding: 2rem 1rem;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem 2rem; border-radius: 1rem; box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.2); margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
            <button id="back-to-list-btn" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: none; backdrop-filter: blur(10px);">
                ‚Üê Back to List
            </button>
            <div style="color: white; font-weight: 600; font-size: 1.1rem;">
                ‚ú® PDF Editor 2.0
            </div>
        </div>
        
        <!-- Tabs Navigation -->
        <div style="background: white; border-radius: 1rem 1rem 0 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow-x: auto;">
            <div class="tabs-nav" style="display: flex; border-bottom: 2px solid #e5e7eb; padding: 0 1rem;">
                <button class="tab-btn active" data-tab="extract" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; color: #6b7280; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    üìÑ Extract Text
                </button>
                <button class="tab-btn" data-tab="ocr" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; color: #6b7280; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    üîç OCR
                </button>
                <button class="tab-btn" data-tab="edit" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; color: #6b7280; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    ‚úèÔ∏è Edit
                </button>
                <button class="tab-btn" data-tab="split" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; color: #6b7280; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    ‚úÇÔ∏è Split
                </button>
                <button class="tab-btn" data-tab="compress" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; color: #6b7280; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    üóúÔ∏è Compress
                </button>
                <button class="tab-btn" data-tab="watermark" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; color: #6b7280; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    üíß Watermark
                </button>
                <button class="tab-btn" data-tab="rotate" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; color: #6b7280; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    üîÑ Rotate
                </button>
                <button class="tab-btn" data-tab="numbers" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; color: #6b7280; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;">
                    üî¢ Page Numbers
                </button>
            </div>
        </div>

        <!-- Content Container -->
        <div style="background: white; border-radius: 0 0 1rem 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 0;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
                <!-- PDF Preview (Persistent) -->
                <div style="padding: 1.5rem; border-right: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; color: #1f2937;">PDF Preview</h3>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button id="prev-page-btn" class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">
                                ‚Üê Prev
                            </button>
                            <span id="page-indicator" style="font-size: 0.875rem; color: #6b7280; min-width: 80px; text-align: center;">
                                Page 1 of 1
                            </span>
                            <button id="next-page-btn" class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">
                                Next ‚Üí
                            </button>
                        </div>
                    </div>
                    <div id="pdf-preview-container" style="border: 1px solid #e5e7eb; border-radius: 0.5rem; height: 650px; overflow: auto; display: flex; justify-content: center; align-items: center; background: #f9fafb;">
                        <canvas id="pdf-canvas"></canvas>
                    </div>
                </div>

                <!-- Tab Panels -->
                <div style="padding: 1.5rem;">
                    <!-- Extract Text Panel -->
                    <div id="panel-extract" class="tab-panel" style="display: block;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; color: #1f2937;">üìÑ Extract Text</h3>
                            <button id="extract-text-btn" class="btn btn-primary">
                                Extract Now
                            </button>
                        </div>
                        <textarea id="extracted-text-area" readonly style="width: 100%; height: 550px; padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-family: monospace; font-size: 0.875rem; resize: none;" placeholder="Click 'Extract Now' to extract text from PDF..."></textarea>
                        <div id="extract-actions" style="display: none; margin-top: 1rem; gap: 0.5rem;">
                            <button id="copy-extract-btn" class="btn btn-secondary">üìã Copy</button>
                            <a href="{% url 'download_text' %}" class="btn btn-primary" style="text-decoration: none;">üì• Download</a>
                        </div>
                    </div>

                    <!-- OCR Panel -->
                    <div id="panel-ocr" class="tab-panel" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; color: #1f2937;">üîç OCR to Text</h3>
                            <button id="ocr-text-btn" class="btn btn-primary">
                                Start OCR
                            </button>
                        </div>
                        <textarea id="ocr-text-area" readonly style="width: 100%; height: 550px; padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-family: monospace; font-size: 0.875rem; resize: none;" placeholder="Click 'Start OCR' to extract text via OCR..."></textarea>
                        <div id="ocr-actions" style="display: none; margin-top: 1rem; gap: 0.5rem;">
                            <button id="copy-ocr-btn" class="btn btn-secondary">üìã Copy</button>
                            <a href="{% url 'download_text' %}" class="btn btn-primary" style="text-decoration: none;">üì• Download</a>
                        </div>
                    </div>

                    <!-- More tab panels will be added here -->
                    <div id="panel-edit" class="tab-panel" style="display: none;">
                        <h3 style="margin: 0 0 1rem 0; color: #1f2937;">‚úèÔ∏è Edit Text</h3>
                        <p style="color: #6b7280;">Coming soon...</p>
                    </div>

                    <div id="panel-split" class="tab-panel" style="display: none;">
                        <h3 style="margin: 0 0 1rem 0; color: #1f2937;">‚úÇÔ∏è Split PDF</h3>
                        <p style="color: #6b7280;">Coming soon...</p>
                    </div>

                    <div id="panel-compress" class="tab-panel" style="display: none;">
                        <h3 style="margin: 0 0 1rem 0; color: #1f2937;">üóúÔ∏è Compress PDF</h3>
                        <p style="color: #6b7280;">Coming soon...</p>
                    </div>

                    <div id="panel-watermark" class="tab-panel" style="display: none;">
                        <h3 style="margin: 0 0 1rem 0; color: #1f2937;">üíß Add Watermark</h3>
                        <p style="color: #6b7280;">Coming soon...</p>
                    </div>

                    <div id="panel-rotate" class="tab-panel" style="display: none;">
                        <h3 style="margin: 0 0 1rem 0; color: #1f2937;">üîÑ Rotate Pages</h3>
                        <p style="color: #6b7280;">Coming soon...</p>
                    </div>

                    <div id="panel-numbers" class="tab-panel" style="display: none;">
                        <h3 style="margin: 0 0 1rem 0; color: #1f2937;">üî¢ Add Page Numbers</h3>
                        <p style="color: #6b7280;">Coming soon...</p>
                    </div>

                    <!-- Loading Indicator -->
                    <div id="loading-indicator" style="display: none; text-align: center; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                        <p style="color: #6b7280;">Processing... This may take a moment.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
// ===== SURPRISE REVEAL ANIMATION =====
// Confetti animation
const canvas = document.getElementById('confetti-canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const confettiPieces = [];
const confettiCount = 150;
const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b'];

for (let i = 0; i < confettiCount; i++) {
    confettiPieces.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height - canvas.height,
        w: Math.random() * 10 + 5,
        h: Math.random() * 10 + 5,
        color: colors[Math.floor(Math.random() * colors.length)],
        speed: Math.random() * 3 + 2,
        rotation: Math.random() * 360
    });
}

function drawConfetti() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    confettiPieces.forEach(p => {
        ctx.save();
        ctx.translate(p.x + p.w / 2, p.y + p.h / 2);
        ctx.rotate(p.rotation * Math.PI / 180);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
        ctx.restore();
        
        p.y += p.speed;
        p.rotation += 2;
        
        if (p.y > canvas.height) {
            p.y = -p.h;
            p.x = Math.random() * canvas.width;
        }
    });
    requestAnimationFrame(drawConfetti);
}

drawConfetti();

// Reveal animation timeline
setTimeout(() => {
    const overlay = document.getElementById('surprise-overlay');
    overlay.style.opacity = '0';
    setTimeout(() => {
        overlay.style.display = 'none';
        document.getElementById('more-tools-modal').style.opacity = '1';
    }, 1000);
}, 2500);

// Stop confetti after 5 seconds
setTimeout(() => {
    canvas.style.display = 'none';
}, 5000);

// ===== TABS NAVIGATION =====
const tabBtns = document.querySelectorAll('.tab-btn');
const tabPanels = document.querySelectorAll('.tab-panel');

tabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
        const targetTab = this.dataset.tab;
        
        // Remove active from all tabs
        tabBtns.forEach(b => {
            b.classList.remove('active');
            b.style.color = '#6b7280';
            b.style.borderBottomColor = 'transparent';
        });
        
        // Add active to clicked tab
        this.classList.add('active');
        this.style.color = '#667eea';
        this.style.borderBottomColor = '#667eea';
        
        // Hide all panels
        tabPanels.forEach(panel => {
            panel.style.display = 'none';
        });
        
        // Show target panel
        document.getElementById(`panel-${targetTab}`).style.display = 'block';
    });
});

// Set initial active state
document.querySelector('.tab-btn.active').style.color = '#667eea';
document.querySelector('.tab-btn.active').style.borderBottomColor = '#667eea';

// ===== PDF.js setup =====
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let currentPdfId = null;
let currentPdfPath = null;
let pdfDoc = null;

// PDF Card Click - Show Preview
document.querySelectorAll('.pdf-card').forEach(card => {
    card.addEventListener('click', function() {
        currentPdfId = this.dataset.pdfId;
        currentPdfPath = `/media/${this.dataset.pdfPath}`;
        
        // Switch views
        document.getElementById('pdf-list-view').style.display = 'none';
        document.getElementById('pdf-tools-view').style.display = 'block';
        
        // Load PDF preview
        loadPdfPreview(currentPdfPath);
    });
});

// Back to List
document.getElementById('back-to-list-btn').addEventListener('click', function() {
    document.getElementById('pdf-tools-view').style.display = 'none';
    document.getElementById('pdf-list-view').style.display = 'block';
    document.getElementById('extracted-text-area').value = '';
    document.getElementById('results-actions').style.display = 'none';
});

// Extract Text
document.getElementById('extract-text-btn').addEventListener('click', function() {
    if (!currentPdfId) return;
    
    const textArea = document.getElementById('extracted-text-area');
    const loading = document.getElementById('loading-indicator');
    const actions = document.getElementById('extract-actions');
    
    textArea.style.display = 'none';
    loading.style.display = 'block';
    actions.style.display = 'none';
    
    fetch(`/extract-text/${currentPdfId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.style.display = 'none';
        textArea.style.display = 'block';
        
        if (data.success) {
            textArea.value = data.text;
            actions.style.display = 'flex';
        } else {
            textArea.value = `Error: ${data.error}`;
        }
    })
    .catch(error => {
        loading.style.display = 'none';
        textArea.style.display = 'block';
        textArea.value = `Error: ${error.message}`;
    });
});

// OCR Text
document.getElementById('ocr-text-btn').addEventListener('click', function() {
    if (!currentPdfId) return;
    
    const textArea = document.getElementById('ocr-text-area');
    const loading = document.getElementById('loading-indicator');
    const actions = document.getElementById('ocr-actions');
    
    textArea.style.display = 'none';
    loading.style.display = 'block';
    actions.style.display = 'none';
    
    fetch(`/ocr-text/${currentPdfId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.style.display = 'none';
        textArea.style.display = 'block';
        
        if (data.success) {
            textArea.value = data.text;
            actions.style.display = 'flex';
        } else {
            textArea.value = `Error: ${data.error}`;
        }
    })
    .catch(error => {
        loading.style.display = 'none';
        textArea.style.display = 'block';
        textArea.value = `Error: ${error.message}`;
    });
});

// Copy Extract Button
document.getElementById('copy-extract-btn').addEventListener('click', function() {
    const textArea = document.getElementById('extracted-text-area');
    textArea.select();
    document.execCommand('copy');
    
    const btn = this;
    const original = btn.textContent;
    btn.textContent = '‚úÖ Copied!';
    setTimeout(() => btn.textContent = original, 2000);
});

// Copy OCR Button
document.getElementById('copy-ocr-btn').addEventListener('click', function() {
    const textArea = document.getElementById('ocr-text-area');
    textArea.select();
    document.execCommand('copy');
    
    const btn = this;
    const original = btn.textContent;
    btn.textContent = '‚úÖ Copied!';
    setTimeout(() => btn.textContent = original, 2000);
});

// Load PDF Preview
let currentPageNum = 1;
let totalPages = 0;

function loadPdfPreview(url) {
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    
    pdfjsLib.getDocument(url).promise.then(function(pdf) {
        pdfDoc = pdf;
        totalPages = pdf.numPages;
        currentPageNum = 1;
        
        updatePageIndicator();
        renderPage(currentPageNum);
    });
}

function renderPage(pageNum) {
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    
    pdfDoc.getPage(pageNum).then(function(page) {
        const viewport = page.getViewport({scale: 1.5});
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        page.render({
            canvasContext: ctx,
            viewport: viewport
        });
    });
}

function updatePageIndicator() {
    document.getElementById('page-indicator').textContent = `Page ${currentPageNum} of ${totalPages}`;
    document.getElementById('prev-page-btn').disabled = currentPageNum <= 1;
    document.getElementById('next-page-btn').disabled = currentPageNum >= totalPages;
}

// Previous Page
document.getElementById('prev-page-btn').addEventListener('click', function() {
    if (currentPageNum <= 1) return;
    currentPageNum--;
    renderPage(currentPageNum);
    updatePageIndicator();
});

// Next Page
document.getElementById('next-page-btn').addEventListener('click', function() {
    if (currentPageNum >= totalPages) return;
    currentPageNum++;
    renderPage(currentPageNum);
    updatePageIndicator();
});
</script>

<style>
@keyframes fadeInScale {
    0% {
        opacity: 0;
        transform: scale(0.9);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes bounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}
</style>
{% endblock %}
```
